<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="google-site-verification" content="J60P8vi3Jy6lEbedlRfNGVBUHV-FfpA-veZxiMFsqcc" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="我见到过地狱与天堂的婚礼，战舰在猎户座肩旁熊熊燃烧！">
    <meta name="keywords"  content="C的博客,UlyC，学习笔记">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="元类和元编程 - C的博客 |UlyC">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="
  元类就是深度的魔法，99%的⽤户应该根本不必为此操⼼。

  如果你想搞清楚 究竟是否需要⽤到元类，那么你就不需要它。

  那些实际⽤到元类的⼈都⾮常 清楚地知道他们需要做什么，⽽且根本不需要解释为什么要⽤元类。

 																—— TimPeters 

">
    
    <meta property="article:published_time" content="2018-10-16T00:00:00Z">
    
    
    <meta property="article:author" content="UlyC">
    
    
    <meta property="article:tag" content="元类">
    
    <meta property="article:tag" content="python黑魔法">
    
    <meta property="article:tag" content="元编程">
    
    <meta property="article:tag" content="面向切面">
    
    <meta property="article:tag" content="抽象基类">
    
    <meta property="article:tag" content="描述器">
    
    <meta property="article:tag" content="面向切面">
    
    
    <meta property="og:image" content="https://UlyC.github.io/img/头像.jpg">
    <meta property="og:url" content="https://UlyC.github.io/2018/10/16/python%E4%B8%AD%E7%9A%84%E5%85%83%E7%B1%BB%E5%92%8C%E5%85%83%E7%BC%96%E7%A8%8B/">
    <meta property="og:site_name" content="C的博客 |UlyC">

    <title>元类和元编程 - C的博客 |UlyC</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Safari Webpage Icon    by-BY -->
    <link rel="favicon.ico" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://UlyC.github.io/2018/10/16/python%E4%B8%AD%E7%9A%84%E5%85%83%E7%B1%BB%E5%92%8C%E5%85%83%E7%BC%96%E7%A8%8B/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <!--    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/fontawesome.min.css" rel="stylesheet" type="text/css">-->
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css"  type="text/css">-->
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.css"  type="text/css">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.css"  type="text/css">
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/4-shims.cs"  type="text/css">-->


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">UlyC</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        <li>
                            <a href="/about">About</a>
                        </li>
                        <li>
                            <a href="/archive">Archive</a>
                        </li>
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        <li>-->
                        <!--                            <a href="/about/">About</a>-->
                        <!--                        </li>-->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        <li>-->
                        <!--                            <a href="/archive/">Archive</a>-->
                        <!--                        </li>-->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        <li>-->
                        <!--                            <a href="/pgp_keys.asc/">PublicKey</a>-->
                        <!--                        </li>-->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        <li>-->
                        <!--                            <a href="/index.html">UlyC</a>-->
                        <!--                        </li>-->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <!--                        -->
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>


    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from
         * $toggle/$collapse will break global delegation.
         *
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>
    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/TheLastNight_08.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header {
        position: relative;
        background-image: url('/img/TheLastNight_08.jpg')
    }

    {
    %
    if
    page
    .
    header-mask
    %
    }
    header.intro-header .header-mask {
        width: 100%;
        height: 100%;
        position: absolute;

    background:

    rgba
    (
    0
    ,
    0
    ,
    0
    ,
    {
    {
        page . header-mask
    }
    }
    )
    ;
    }
    {
    %
    endif
    %
    }
</style>
<header class="intro-header">
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#元类" title="元类">元类</a>
                        
                        <a class="tag" href="/tags/#python黑魔法" title="python黑魔法">python黑魔法</a>
                        
                        <a class="tag" href="/tags/#元编程" title="元编程">元编程</a>
                        
                        <a class="tag" href="/tags/#面向切面" title="面向切面">面向切面</a>
                        
                        <a class="tag" href="/tags/#抽象基类" title="抽象基类">抽象基类</a>
                        
                        <a class="tag" href="/tags/#描述器" title="描述器">描述器</a>
                        
                        <a class="tag" href="/tags/#面向切面" title="面向切面">面向切面</a>
                        
                    </div>
                    <h1>元类和元编程</h1>
                    
                    
                    <h2 class="subheading">别用！</h2>
                    
                    <span class="meta">Posted by UlyC on October 16, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <blockquote>
  <p>元类就是深度的魔法，99%的⽤户应该根本不必为此操⼼。</p>

  <p>如果你想搞清楚 究竟是否需要⽤到元类，那么你就不需要它。</p>

  <p>那些实际⽤到元类的⼈都⾮常 清楚地知道他们需要做什么，⽽且根本不需要解释为什么要⽤元类。</p>

 																—— TimPeters <br />
</blockquote>

<h1 id="元类和元编程">元类和元编程</h1>

<h2 id="一元类">一、元类</h2>

<h3 id="概念">概念</h3>

<blockquote>
  <p>元类（<em>metaclass</em> ）<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>，就是创建类的类。</p>
</blockquote>

<p>这么说可能不太好理解，下面我们来解释下上面这句话：</p>

<p>在⼤多数编程语⾔中，类就是⼀组⽤来描述如何⽣成⼀个对象的代码段，在python中也不例外。</p>

<p>实例对象是由类生成的，而python中，类本身也是可以被传递和自省的对象。</p>

<p>类对象是用什么创建和生成的呢？答案是元类，元类就是一种知道如何创建和管理类的对象，也可以叫做类生成器。</p>

<h3 id="__-class-__-和type">__ class __ 和type</h3>

<p>知道了元类的概念，那么我们怎么查看python中的元类具体是什么东西呢？</p>

<p>python中对象有个魔法属性<code class="language-plaintext highlighter-rouge">__class__</code>,可以查看对象是由哪个类创建出来的：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Python</span> <span class="mf">3.7</span><span class="p">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Jun</span> <span class="mi">28</span> <span class="mi">2018</span><span class="p">,</span> <span class="mi">08</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">48</span><span class="p">)</span> <span class="p">[</span><span class="n">MSC</span> <span class="n">v</span><span class="p">.</span><span class="mi">1912</span> <span class="mi">64</span> <span class="n">bit</span> <span class="p">(</span><span class="n">AMD64</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="s">"abc"</span><span class="p">.</span><span class="n">__class__</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">''</span><span class="nc">str</span><span class="s">''</span><span class="o">&gt;</span>  <span class="c1"># 字符串“abc”是由“str”类实例化出来的
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">123</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">num</span><span class="p">.</span><span class="n">__class__</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">''</span><span class="nc">int</span><span class="s">''</span><span class="o">&gt;</span>   <span class="c1"># 没错，int、str等数据类型也是一个个的类，
# 具体的字符串和数字其实是他们实例化对象。
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Demo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">demo</span> <span class="o">=</span> <span class="n">Demo</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">demo</span><span class="p">.</span><span class="n">__class__</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">__main__</span><span class="p">.</span><span class="n">Demo</span><span class="s">'&gt;
&gt;&gt;&gt; Demo.__class__
&lt;class '</span><span class="nb">type</span><span class="s">'&gt;
</span></code></pre></div></div>

<p>可以看到类对象的类，就是<code class="language-plaintext highlighter-rouge">type</code>。</p>

<p>这个<code class="language-plaintext highlighter-rouge">type</code>其实就是平时我们用来查看数据类型的内建函数：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">''</span><span class="nc">int</span><span class="s">''</span><span class="o">&gt;</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">Demo</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">type</span><span class="s">'&gt;
</span></code></pre></div></div>

<p>在只使用这个功能时，作用与<code class="language-plaintext highlighter-rouge">__class__</code>相同。</p>

<p>而其实<code class="language-plaintext highlighter-rouge">type</code>就是一个元类，它还有⼀种完全不同的功能：动态的创建类。<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></p>

<p>语法为：<code class="language-plaintext highlighter-rouge">type(类名, 由⽗类名称组成的元组（针对继承的情况，可以为空）， 包含属性的字典)</code></p>

<p>例如：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="s">"Demo2"</span><span class="p">,(</span><span class="nb">object</span><span class="p">),{})</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">''</span><span class="nc">__main__</span><span class="p">.</span><span class="n">Demo2</span><span class="s">''</span><span class="o">&gt;</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">demo2</span> <span class="o">=</span> <span class="n">Demo2</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">demo2</span>
<span class="o">&lt;</span><span class="n">__main__</span><span class="p">.</span><span class="n">Demo2</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000001F71DBE5EF0</span><span class="o">&gt;</span>      
</code></pre></div></div>

<p>由type动态创建的 <code class="language-plaintext highlighter-rouge">Demo2</code>类对象，和由<code class="language-plaintext highlighter-rouge">“class ...”</code>创建的<code class="language-plaintext highlighter-rouge">Demo</code>，两者完全等价。</p>

<p>python 3以后<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>，默认的元类皆为<code class="language-plaintext highlighter-rouge">type</code>，即所有的类对象默认都是由<code class="language-plaintext highlighter-rouge">type</code>创建的，接下来让我们来自定义一个元类。</p>

<h3 id="创建一个元类">创建一个元类</h3>

<p>最简单的，自定义一个继承自type的子类，想要使用它创建类对象时在类中使用<code class="language-plaintext highlighter-rouge">__metaclass__</code>声明一下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="p">...</span>      <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Meta</span>       <span class="c1"># python2
</span><span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span>     <span class="c1"># python3
</span><span class="p">...</span>     <span class="k">pass</span>
</code></pre></div></div>

<p>一般来说，定义的元类应该重新实现<code class="language-plaintext highlighter-rouge">__init__()</code>与<code class="language-plaintext highlighter-rouge">__new__()</code>方法。</p>

<ul>
  <li>如果需要修改类的属性，使用元类的<code class="language-plaintext highlighter-rouge">__new__</code>方法</li>
  <li>如果只是做一些类属性检查的工作，使用元类的<code class="language-plaintext highlighter-rouge">__init__</code>方法。</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>   <span class="c1"># 注意第一个参数是cls而不是self
</span><span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="s">'create class %s'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="p">...</span>         <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
<span class="p">...</span>
<span class="p">...</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
<span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="s">'Init class %s'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="p">...</span>         <span class="nb">type</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>   <span class="c1"># 注意__init__方法禁止返回值
</span><span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="n">create</span> <span class="k">class</span> <span class="nc">Base</span>
<span class="n">Init</span> <span class="k">class</span> <span class="nc">Base</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Base</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">__main__</span><span class="p">.</span><span class="n">Base</span><span class="s">'&gt;
</span></code></pre></div></div>

<h4 id="metaclass拓展">metaclass拓展</h4>

<p>事实上，<code class="language-plaintext highlighter-rouge">__metaclass__</code>实际上可以被任意调⽤，它只是规定了类“按照什么样的规则去生成”，并不需要是⼀个正式 的类。</p>

<p>比如，我们有一个比较二的需求：你决定在你的模块⾥，所有的类的属性都应该是⼤写形式。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">upper_attr</span><span class="p">(</span><span class="n">future_class_name</span><span class="p">,</span> <span class="n">future_class_parents</span><span class="p">,</span> <span class="n">future_class_attr</span><span class="p">):</span>
<span class="p">...</span>		<span class="s">"""遍历属性字典，把不是__开头的属性名字变为⼤写"""</span>
<span class="p">...</span>     <span class="n">newAttr</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">...</span>     <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">future_class_attr</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
<span class="p">...</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"__"</span><span class="p">):</span>
<span class="p">...</span>                     <span class="n">newAttr</span><span class="p">[</span><span class="n">name</span><span class="p">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>
<span class="p">...</span>     <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">future_class_name</span><span class="p">,</span> <span class="n">future_class_parents</span><span class="p">,</span> <span class="n">newAttr</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">upper_attr</span><span class="p">):</span>
<span class="p">...</span>     <span class="n">bar</span><span class="o">=</span> <span class="s">'bip'</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">.</span><span class="n">bar</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">AttributeError</span><span class="p">:</span> <span class="s">'Foo'</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">'bar'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">.</span><span class="n">BAR</span>
<span class="s">'bip'</span>
</code></pre></div></div>

<h3 id="元类冲突">元类冲突</h3>

<p>假如有两个不同的元类，要生成一个继承这两个类的子类，会产生什么情况呢？</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">MetaA</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">MetaB</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaA</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaB</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="n">metaclass</span> <span class="n">conflict</span><span class="p">:</span> <span class="n">the</span> <span class="n">metaclass</span> <span class="n">of</span> <span class="n">a</span> <span class="n">derived</span> <span class="k">class</span> <span class="nc">must</span> <span class="n">be</span> <span class="n">a</span> <span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">strict</span><span class="p">)</span> <span class="n">subclass</span> <span class="n">of</span> <span class="n">the</span> <span class="n">metaclasses</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">its</span> <span class="n">bases</span>
</code></pre></div></div>

<p>这时会报错， 元类冲突。</p>

<p>我们需要手动构造新的子类元类，让新的子类元类继承自A和B的元类：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">MetaC</span><span class="p">(</span><span class="n">MetaA</span><span class="p">,</span> <span class="n">MetaB</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaC</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
</code></pre></div></div>

<p>这样就不会报错了。</p>

<h2 id="二元类的应用">二、元类的应用</h2>

<p>应用元类之前我们首先要知道使用元类编程的缺点：</p>

<ul>
  <li>实现麻烦</li>
  <li>代码可读性不高</li>
  <li>不易维护</li>
</ul>

<p>其实在开头引用TimPeters的话就说明，不要随意在生产代码中使用元类，而且现有的编码规范也极不推荐使用。</p>

<p>好吧，了解元类的使用对你更深入理解一些框架是有帮助的，如果你执意要学习这门禁术，那就往下看吧！</p>

<p>===========================禁术分割线 =======================</p>

<p>就元类本身而言，它的作用是：</p>

<ul>
  <li>拦截类的创建</li>
  <li>修改类</li>
  <li>返回修改之后的类</li>
</ul>

<p>使用元类还是有一些好处的：</p>

<ul>
  <li>意图更加明确。当然你的metaclass名字要起好</li>
  <li>面向对象。可以隐式继承到子类</li>
  <li>可以更好地组织代码</li>
  <li>可以用<code class="language-plaintext highlighter-rouge">__new__</code>，<code class="language-plaintext highlighter-rouge">__init__,__call__</code>等方法更好地控制</li>
</ul>

<p>这里先简单说几个简单的应用实例：</p>

<h3 id="实现单例模式">实现单例模式</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
		<span class="s">"""通过重写__call__拦截实例的创建,(实例通过调用括号运算符创建的)"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="p">.</span><span class="n">instance</span><span class="p">:</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">().</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="n">instance</span>
</code></pre></div></div>

<h3 id="面向切面aop编程">面向切面（AOP）编程</h3>

<p>在运行时，动态地将代码切入到类的指定方法、指定位置上的编程称为面向切面的编程(AOP)。</p>

<p>简单地说，如果不同的类要实现相同的功能，可以将其中相同的代码提取到一个切片中，等到需要时再切入到对象中去。这些相同的代码片段称为切面，而切入到哪些类、哪些方法则叫切入点。</p>

<p><strong>【注意】</strong>：python的装饰器天然适合AOP，简单易读又好用。使用元类AOP纯属自找麻烦，这里主要是说下原理，并不是让大家去用。（在生产代码中炫技很讨厌的说(′゜c_，゜` ) ）</p>

<p>面向切面比较常用的是为类方法添加记录日志功能，下面使用元类来实现此功能：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">callfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="err">（</span><span class="s">'debug_log.txt'</span><span class="p">,</span> <span class="s">'a'</span><span class="err">）</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>           
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Calling %s: %s ,%s</span><span class="se">\n</span><span class="s">'</span><span class="o">%</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'%s returned %s</span><span class="se">\n</span><span class="s">'</span><span class="o">%</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">callfunc</span>
 
 
<span class="k">class</span> <span class="nc">LogMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attr_dct</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attr_dct</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">FunctionType</span><span class="p">):</span>
                <span class="c1"># 如果v是函数类型, 使用trace处理，添加日志
</span>                <span class="n">attr_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attr_dct</span><span class="p">)</span>
 

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="err">，</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">LogMeta</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
 
    <span class="k">def</span> <span class="nf">spam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Foo</span><span class="p">.</span><span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">Foo</span><span class="p">.</span><span class="n">num</span>
</code></pre></div></div>

<h3 id="对抽象基类的支持">对抽象基类的支持</h3>

<p>简单的说，抽象基类就是包含一个或者多个抽象方法的类。</p>

<p>它本身不实现抽象方法，强制子类去实现，同时抽象基类自己不能被实例化，没有实现抽象方法的子类也无法实例化。</p>

<p>python内置的abc(abstract base class)来实现抽象基类。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

</code></pre></div></div>

<p>使用这种方式如果没有在子类里实现foo方法你是没有办法实例化抽象基类Base的子类的 。</p>

<p>另外应该优先使用<code class="language-plaintext highlighter-rouge">collections</code>定义的抽象基类，比如要实现一个容器我们可以继承 <code class="language-plaintext highlighter-rouge">collections.Container</code></p>

<h3 id="实现orm">实现ORM</h3>

<p>这个比较复杂，在下一章再详细说。</p>

<h2 id="三元编程">三、元编程</h2>

<h3 id="概念-1">概念</h3>

<blockquote>
  <p><strong>元编程</strong>（英语：Metaprogramming），又译<strong>超编程</strong>，是指某类<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F">计算机程序</a>的编写，这类计算机程序编写或者操纵其它程序（或者自身）作为它们的数据，或者在<a href="https://zh.wikipedia.org/wiki/%E8%BF%90%E8%A1%8C%E6%97%B6">运行时</a>完成部分本应在<a href="https://zh.wikipedia.org/wiki/%E7%BC%96%E8%AF%91%E6%97%B6">编译时</a>完成的工作。多数情况下，与手工编写全部代码相比，程序员可以获得更高的工作效率，或者给与程序更大的灵活度去处理新的情形而无需重新编译。</p>

  <p>编写元程序的语言称之为<a href="https://zh.wikipedia.org/wiki/%E5%85%83%E8%AA%9E%E8%A8%80">元语言</a>。被操纵的程序的语言称之为“<a href="https://zh.wikipedia.org/w/index.php?title=%E7%9B%AE%E6%A0%87%E8%AF%AD%E8%A8%80&amp;action=edit&amp;redlink=1">目标语言</a>”。一门编程语言同时也是自身的元语言的能力称之为“<a href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%B0%84_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">反射</a>”或者“自反”。</p>
</blockquote>

<p>以上引自维基百科，<a href="https://zh.wikipedia.org/wiki/%E5%85%83%E7%BC%96%E7%A8%8B">元编程</a>。</p>

<p>许多人将「元类编程」和「元编程」混为一谈，甚至说“元编程 == 元类编程”，这是非常不对的。</p>

<p>就比如python，使用Cpython解释器时，C语言就是元语言，python就是目标语言，C语言对python进行了元编程。</p>

<p>元编程在不同的语言中有不同的实现，在Python中，元编程实现通常有这几个手段：</p>

<ul>
  <li>魔法方法</li>
  <li>描述器（descriptor）</li>
  <li>元类</li>
  <li>eval函数</li>
</ul>

<h3 id="应用">应用</h3>

<p>元编程常见的应用场景很多，扩展（重构）语法、开发DSL、生成代码、根据特定场景自动选择代码优化、解决一些正交的架构设计问题、AOP等等。</p>

<p>所以元编程存在的目的，就是多提供了一个抽象层次。</p>

<p>至于元编程有什么缺点，争议还是比较大的。比如以重构语法的应用为例，很多元编程的反对者就认为这样会导致代码的可读性、可维护性降低，分化社区，影响交流，因为每个开发人员都能搞一个自己的方言 。</p>

<p>对于作为”胶水语言”的python，对各种其他语言库的支持（ctypes、js2py等），更是元编程应用很好的实例。</p>

<p>很经典的一个应用就是使用元类在python语言和数据库中间增加一个抽象层：ORM层。</p>

<h3 id="orm的简单实现">ORM的简单实现</h3>

<h4 id="orm">ORM</h4>

<p>ORM全称“Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作SQL语句。</p>

<p>以下代码参考自文章<a href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386820064557c69858840b4c48d2b8411bc2ea9099ba000">使用元类-—廖雪峰的官方网站</a>。</p>

<p>编写底层模块的第一步，就是先把调用接口写出来。比如，使用者如果使用这个ORM框架，想定义一个<code class="language-plaintext highlighter-rouge">User</code>类来操作对应的数据库表<code class="language-plaintext highlighter-rouge">User</code>，我们期待他写出这样的代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># 定义类的属性到列的映射：
</span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'username'</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'email'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'password'</span><span class="p">)</span>

<span class="c1"># 创建一个实例：
</span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Michael'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'test@orm.org'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'my-pwd'</span><span class="p">)</span>
<span class="c1"># 保存到数据库：
</span><span class="n">u</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>其中，父类<code class="language-plaintext highlighter-rouge">Model</code>和属性类型<code class="language-plaintext highlighter-rouge">StringField</code>、<code class="language-plaintext highlighter-rouge">IntegerField</code>是由ORM框架提供的，剩下的魔术方法比如<code class="language-plaintext highlighter-rouge">save()</code>全部由metaclass自动完成。虽然metaclass的编写会比较复杂，但ORM的使用者用起来却异常简单。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""负责保存数据库表的字段名和字段类型"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">column_type</span> <span class="o">=</span> <span class="n">column_type</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'&lt;%s:%s&gt;'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    
    
<span class="k">class</span> <span class="nc">StringField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">'varchar(100)'</span><span class="p">)</span>   <span class="c1">#python2中super里要带参数
</span>        
        
<span class="k">class</span> <span class="nc">IntegerField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">'bigint'</span><span class="p">)</span>
        

<span class="k">class</span> <span class="nc">ModelMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="s">"""自定义元类"""</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s">'Model'</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Found model: %s'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        
        <span class="c1"># 排除掉对Model类的修改
</span>        <span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'Found mapping: %s ==&gt; %s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        
        <span class="c1"># 从类属性中删除该Field属性，否则，实例的属性会遮盖类的同名属性，运行错误    
</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attrs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  
        
        <span class="n">attrs</span><span class="p">[</span><span class="s">'__mappings__'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mappings</span>   <span class="c1"># 保存属性和列的映射关系
</span>        <span class="n">attrs</span><span class="p">[</span><span class="s">'__table__'</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>     <span class="c1"># 假设表名和类名一致（简化）
</span>        <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
 

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ModelMetaclass</span><span class="p">):</span>
    <span class="s">"""只简单实现了INSERT功能"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">AttributeError</span><span class="p">(</span><span class="sa">r</span><span class="s">"'Model' object has no attribute '%s'"</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>  
        
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">__mappings__</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fields</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">params</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'?'</span><span class="p">)</span>
            <span class="n">args</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        
        <span class="n">sql</span> <span class="o">=</span> <span class="s">'insert into %s (%s) values (%s)'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__table__</span><span class="p">,</span> <span class="s">','</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="s">','</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'SQL: %s'</span> <span class="o">%</span> <span class="n">sql</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'ARGS: %s'</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</code></pre></div></div>

<p>这样，就实现了一个简单的ORM框架。</p>

<h2 id="后记">后记</h2>

<p>本来想在这里一起把抽象基类（abc）和面向切面编程（AOP）的几种实现一起谈谈，结果篇幅又是远超我的想象，还是以后有机会慢慢写吧….</p>

<h2 id="参考链接">参考链接</h2>

<p>[1].<a href="https://www.ibm.com/developerworks/cn/linux/l-pymeta/index.html">Python 中的元类编程</a></p>

<p>[2]. <a href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386820064557c69858840b4c48d2b8411bc2ea9099ba000">使用元类-—廖雪峰的官方网站</a></p>

<p>[3].<a href="https://www.zhihu.com/question/23856985/answer/25965835">怎么理解元编程？ - 知乎用户的回答 - 知乎 </a></p>

<p>[4].<a href="https://www.cnblogs.com/linxiyue/p/8030604.html">元类与面向切面编程——再见紫罗兰的博客</a></p>

<p>[5].<a href="https://zhuanlan.zhihu.com/p/28333506">『简单的』Python 元类 - Pegasus Wang的文章 - 知乎 </a></p>

<p>[6]. <a href="https://stackoverflow.com/questions/100003/what-are-metaclasses-in-python">What are metaclasses in Python?——StackOverflow</a></p>

<p>[7]. <a href="https://blog.csdn.net/VCCTor/article/details/50636882">Python元编程-被遗忘的远古凶兽</a></p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Meta- 这个前缀在希腊语中的本意是「在…后，越过…的」，类似于拉丁语的 post-，比如 metaphysics 就是「在物理学之后」（形而上学），这个词最开始指一些亚里士多德的著作，因为它们通常排序在《物理学》之后。            但西方哲学界在几千年中渐渐赋予该词缀一种全新的意义：关于某事自身的某事。比如 meta-knowledge 就是「关于知识本身的知识」，meta-data 就是「关于数据的数据」，meta-language 就是「关于语言的语言」，类似的，metaclass就是「关于类的类」。 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>在python 2中，默认的元类是types.ClassType，就是所谓的旧样式类。python2.2以后已不提倡使用。 <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>既然type也是一种“类”，为什么不写成“Type”呢？ 想想“str”、“int”等“类”，这里应该是为了和他们保持一致。 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/10/09/%E6%B2%A1%E9%82%A3%E4%B9%88%E6%B5%85%E5%9C%B0%E8%B0%88%E8%B0%88HTTP%E4%B8%8EHTTPS-%E4%B8%89/"
                           data-toggle="tooltip" data-placement="top" title="没那么浅地谈谈HTTP与HTTPS【三】">
                            Previous<br>
                            <span>没那么浅地谈谈HTTP与HTTPS【三】</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/12/16/win10%E4%BD%BF%E7%94%A8pyhcarm%E9%85%8D%E5%90%88WSL%E5%BC%80%E5%8F%91python/" data-toggle="tooltip"
                           data-placement="top" title="win10配合Ubuntu子系统打造舒适Python开发环境">
                            Next<br>
                            <span>win10配合Ubuntu子系统打造舒适Python开发环境</span>
                        </a>
                    </li>
                    
                </ul>

                <!--utterances评论start  -->
                
                <script src="https://utteranc.es/client.js"
                        repo='UlyC/UlyC.github.io'
                        issue-term="title"
                        label="comment"
                        theme="github-light"
                        crossorigin="anonymous"
                        async>
                </script>
                
                <!--utterances end  -->


                <!--Gitalk评论start  -->
                
                <!-- Gitalk end -->

                

            </div>

            <!-- Side Catalog Container -->
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function (e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js", function () {
        anchors.options = {
            visible: 'always',
            placement: 'right',
            icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link {
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top: -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-rss fa-stack-1x"></i>
                            </span>
                        </a>
                    </li>
                    

                    

                    
                    <li>
                        <a target="_blank" href="https://keybase.io/ulyc404">
                            <span class="fa-stack fa-lg">
                                <i class="fab fa-keybase fa-stack-1x "></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li>
                        <a target="_blank" href="http://hkps.pool.sks-keyservers.net/pks/lookup?op=vindex&fingerprint=on&search=0xdcf32409f0976589">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-fingerprint fa-stack-1x "></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/UlyC">
                            <span class="fa-stack fa-lg">
                                <i class="fab fa-github fa-stack-1x "></i>
                            </span>
                        </a>
                    </li>
                    
                    

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; UlyC 2021
                    <br>
                    Theme on <a href="git@github.com:UlyC/ulycBlog.git">GitHub</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=UlyC&repo=UlyC.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script type="text/javascript">
    if(navigator.serviceWorker){
        // For security reasons, a service worker can only control the pages that are in the same directory level or below it. That's why we put sw.js at ROOT level.
        navigator.serviceWorker
            .register('/sw.js')
            .then((registration) => {console.log('Service Worker Registered. ', registration)})
            .catch((error) => {console.log('ServiceWorker registration failed: ', error)})
    }
</script>



<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/ 
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers   
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-114814969-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason,
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/favicon.ico" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->
<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="知识共享许可协议" style="border-width:0" 
 src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a><br />本作品采用<a rel="license"
 href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。
</body>

</html>
